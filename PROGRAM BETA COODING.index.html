<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PROGRAM-BETA — Local Lua Encryptor</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:820px;margin:28px auto;padding:18px;}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:1.25rem;margin:0}
  .card{margin-top:18px;padding:16px;border-radius:10px;background:#f7f7f9;border:1px solid #e6e6e9}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input[type=file]{display:block}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:8px;border:none;background:#0b5fff;color:white;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:default}
  textarea{width:100%;height:120px}
  footer{margin-top:18px;font-size:.9rem;color:#555}
  .small{font-size:.88rem;color:#333}
  select,input[type=text],input[type=password]{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%}
  .muted{color:#666;font-size:.9rem}
</style>
</head>
<body>
<header>
  <div>
    <h1>PROGRAM-BETA — Encryptor Lokal</h1>
    <div class="muted">Pilih file → masukkan password → klik Encrypt. Semua proses di browser (offline).</div>
  </div>
</header>

<div class="card">
  <label for="file">Pilih file (.lua / .txt / lainnya)</label>
  <input id="file" type="file" accept="*/*">

  <label for="password">Password / Passphrase (untuk AES-GCM)</label>
  <input id="password" type="password" placeholder="Masukkan password kuat (minimal 8 karakter)">

  <label for="method">Metode enkripsi</label>
  <select id="method">
    <option value="aes">AES-GCM (direkomendasikan, aman)</option>
    <option value="xor">XOR (simple/fast, kompatibel obfuscator ringan)</option>
    <option value="custom">Custom (paste fungsi JS custom)</option>
  </select>

  <div style="margin-top:10px" class="row">
    <button id="encryptBtn" class="btn">Encrypt</button>
    <button id="downloadB64" class="btn" style="background:#0a8f2f">Download Base64</button>
    <button id="showHex" class="btn" style="background:#666">Show Hex</button>
  </div>

  <div style="margin-top:12px">
    <label>Log / Output</label>
    <textarea id="log" readonly></textarea>
  </div>

  <div style="margin-top:12px">
    <label>Jika ingin hasil identik dengan enkripsi Lua-mu, tempelkan versi JS (atau minta aku konversi):</label>
    <textarea id="customJs" placeholder="// function encryptWithCustom(u8, pass){ /* return Uint8Array */ }"></textarea>
    <div class="small muted">Fungsi harus bernama <code>encryptWithCustom(u8, pass)</code> dan mengembalikan <code>Uint8Array</code>.</div>
  </div>
</div>

<footer>
  <div class="muted">Catatan: file tetap di perangkatmu. Untuk hosting private gunakan repo private / Google Drive.</div>
</footer>

<script>
function log(msg){
  const t = document.getElementById('log');
  t.value = (new Date()).toLocaleTimeString() + " — " + msg + "\n" + t.value;
}
function abToBase64(buf){
  const bytes = new Uint8Array(buf);
  let binary = '';
  const chunk = 0x8000;
  for (let i=0; i<bytes.length; i+=chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
  }
  return btoa(binary);
}
function base64ToAb(b64){
  const binary = atob(b64);
  const len = binary.length;
  const u8 = new Uint8Array(len);
  for (let i=0;i<len;i++) u8[i]=binary.charCodeAt(i);
  return u8.buffer;
}
async function deriveKey(pass, salt){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pass),'PBKDF2',false,['deriveKey']);
  const key = await crypto.subtle.deriveKey({
    name:'PBKDF2',
    salt: salt,
    iterations: 200000,
    hash: 'SHA-256'
  }, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt']);
  return key;
}
async function aesGcmEncrypt(u8, pass){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pass, salt);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv: iv}, key, u8);
  const out = new Uint8Array(salt.byteLength + iv.byteLength + ct.byteLength);
  out.set(salt, 0);
  out.set(iv, salt.byteLength);
  out.set(new Uint8Array(ct), salt.byteLength + iv.byteLength);
  return out;
}
function xorEncryptSync(u8, keyStr){
  if(!keyStr) throw "XOR perlu key (passphrase)";
  const key = new TextEncoder().encode(keyStr);
  const out = new Uint8Array(u8.length);
  for(let i=0;i<u8.length;i++){
    out[i] = u8[i] ^ key[i % key.length];
  }
  return out;
}
function tryCustomEncrypt(u8, pass){
  const code = document.getElementById('customJs').value;
  if(!code || code.trim()==="") throw "No custom JS code provided.";
  const wrapper = new Function(code + "\n return encryptWithCustom;");
  const fn = wrapper();
  if(typeof fn !== 'function') throw "encryptWithCustom not found.";
  const result = fn(u8, pass);
  if(!(result instanceof Uint8Array)) throw "encryptWithCustom must return Uint8Array.";
  return result;
}
function downloadUint8AsFile(u8, filename){
  const blob = new Blob([u8], {type:'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
}
document.getElementById('encryptBtn').addEventListener('click', async ()=>{
  const fileInput = document.getElementById('file');
  const pass = document.getElementById('password').value || '';
  const method = document.getElementById('method').value;
  if(!fileInput.files || fileInput.files.length===0){ alert("Pilih file dulu."); return; }
  const file = fileInput.files[0];
  log("Memulai enkripsi: " + file.name + " (metode: " + method + ")");
  try{
    const ab = await file.arrayBuffer();
    let out;
    if(method === 'aes'){
      if(!pass || pass.length < 6){ if(!confirm("Password kurang panjang (<6). Lanjut?")) throw "Weak pass"; }
      out = await aesGcmEncrypt(new Uint8Array(ab), pass);
    } else if(method === 'xor'){
      if(!pass) throw "XOR memerlukan passphrase (key).";
      out = xorEncryptSync(new Uint8Array(ab), pass);
    } else {
      out = tryCustomEncrypt(new Uint8Array(ab), pass);
    }
    const outName = file.name + ".enc";
    downloadUint8AsFile(out, outName);
    const b64 = abToBase64(out.buffer);
    const short = b64.substring(0, 800) + (b64.length > 800 ? "\n... (truncated)":"");
    log("Enkripsi selesai. File diunduh: " + outName + " | size: " + out.length + " bytes");
    window.latestBase64 = b64;
    document.getElementById('downloadB64').disabled = false;
    document.getElementById('showHex').disabled = false;
  }catch(err){
    log("Error: " + (err && err.message ? err.message : err));
    alert("Terjadi error: " + err);
  }
});
document.getElementById('downloadB64').addEventListener('click', ()=>{
  if(!window.latestBase64){ alert("Belum ada output base64. Enkripsi dulu."); return; }
  const b64 = window.latestBase64;
  const blob = new Blob([b64], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'encrypted_base64.txt';
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2000);
  log("Base64 siap di-download (encrypted_base64.txt).");
});
document.getElementById('showHex').addEventListener('click', ()=>{
  if(!window.latestBase64){ alert("Belum ada output base64."); return; }
  const u8 = new Uint8Array(base64ToAb(window.latestBase64));
  const n = Math.min(128, u8.length);
  let s = '';
  for(let i=0;i<n;i++) s += u8[i].toString(16).padStart(2,'0') + ' ';
  alert("Hex (first " + n + " bytes):\n" + s);
});
document.getElementById('downloadB64').disabled = true;
document.getElementById('showHex').disabled = true;
</script>
</body>
</html>
